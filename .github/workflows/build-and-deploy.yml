name: Build and Deploy

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: rg.pl-waw.scw.cloud/garganache
      BACKEND_IMAGE: rg.pl-waw.scw.cloud/garganache/mobi-backend
      FRONTEND_IMAGE: rg.pl-waw.scw.cloud/garganache/mobi-frontend
      SCW_K8S_CLUSTER_ID: ${{ secrets.SCW_K8S_CLUSTER_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure Scaleway env
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          SCW_DEFAULT_REGION: ${{ secrets.SCW_DEFAULT_REGION }}
        run: |
          echo "Scaleway env configured"

      - name: Install Scaleway CLI
        run: |
          curl -s https://raw.githubusercontent.com/scaleway/scaleway-cli/master/scripts/get.sh | sudo sh
          scw version

      - name: Configure Scaleway CLI profile
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
          SCW_DEFAULT_REGION: ${{ secrets.SCW_DEFAULT_REGION }}
        run: |
          scw init \
            secret-key="$SCW_SECRET_KEY" \
            access-key="$SCW_ACCESS_KEY" \
            organization-id="$SCW_DEFAULT_ORGANIZATION_ID" \
            project-id="$SCW_DEFAULT_PROJECT_ID" \
            region="$SCW_DEFAULT_REGION" \
            send-telemetry=false \
            with-ssh-key=false

      - name: Install kubeconfig for cluster
        env:
          SCW_KUBECONFIG_B64: ${{ secrets.SCW_KUBECONFIG_B64 }}
        run: |
          mkdir -p ~/.kube
          echo "$SCW_KUBECONFIG_B64" | base64 -d > ~/.kube/config

      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl

      - name: Docker login to Scaleway registry
        env:
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
        run: |
          echo "$SCW_SECRET_KEY" | docker login rg.pl-waw.scw.cloud/garganache -u nologin --password-stdin

      - name: Build backend image
        run: |
          docker build -t $BACKEND_IMAGE:${{ github.sha }} backend
          docker tag $BACKEND_IMAGE:${{ github.sha }} $BACKEND_IMAGE:latest

      - name: Build frontend image
        run: |
          docker build -t $FRONTEND_IMAGE:${{ github.sha }} frontend
          docker tag $FRONTEND_IMAGE:${{ github.sha }} $FRONTEND_IMAGE:latest

      - name: Push backend image
        run: |
          docker push $BACKEND_IMAGE:${{ github.sha }}
          docker push $BACKEND_IMAGE:latest

      - name: Push frontend image
        run: |
          docker push $FRONTEND_IMAGE:${{ github.sha }}
          docker push $FRONTEND_IMAGE:latest

      - name: Deploy to Kubernetes
        run: |
          # Ensure namespace exists before other manifests
          kubectl apply -f k8s/namespace.yaml

          # Apply core app manifests
          kubectl apply -f k8s/backend.yaml -f k8s/frontend.yaml -f k8s/ingress.yaml

          # Update images to the commit-specific tags
          kubectl -n mobi-dev set image deployment/mobi-backend mobi-backend=$BACKEND_IMAGE:${{ github.sha }}
          kubectl -n mobi-dev set image deployment/mobi-frontend mobi-frontend=$FRONTEND_IMAGE:${{ github.sha }}

          # Show deployed resources
          kubectl -n mobi-dev get pods
          echo "--- mobi-dev services ---"
          kubectl -n mobi-dev get svc
          echo "--- mobi-dev ingress ---"
          kubectl -n mobi-dev get ingress -o wide
