name: Build and Deploy

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: rg.pl-waw.scw.cloud/garganache
      BACKEND_IMAGE: rg.pl-waw.scw.cloud/garganache/mobi-backend
      FRONTEND_IMAGE: rg.pl-waw.scw.cloud/garganache/mobi-frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Configure Scaleway env
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          SCW_DEFAULT_REGION: ${{ secrets.SCW_DEFAULT_REGION }}
        run: |
          echo "Scaleway env configured"

      - name: Terraform init (dev)
        working-directory: infra/terraform/envs/dev
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          SCW_DEFAULT_REGION: ${{ secrets.SCW_DEFAULT_REGION }}
          TF_VAR_scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          TF_VAR_scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          TF_VAR_scw_project_id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          TF_VAR_scw_region: ${{ secrets.SCW_DEFAULT_REGION }}
        run: |
          terraform init -input=false

      - name: Capture K8s cluster id
        working-directory: infra/terraform/envs/dev
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          SCW_DEFAULT_REGION: ${{ secrets.SCW_DEFAULT_REGION }}
          TF_VAR_scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          TF_VAR_scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          TF_VAR_scw_project_id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          TF_VAR_scw_region: ${{ secrets.SCW_DEFAULT_REGION }}
        run: |
          terraform output -raw k8s_cluster_id > $GITHUB_WORKSPACE/k8s_cluster_id

      - name: Install Scaleway CLI
        run: |
          curl -s https://raw.githubusercontent.com/scaleway/scaleway-cli/master/scripts/get.sh | sudo sh
          scw version

      - name: Configure Scaleway CLI profile
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
          SCW_DEFAULT_REGION: ${{ secrets.SCW_DEFAULT_REGION }}
        run: |
          scw init \
            secret-key="$SCW_SECRET_KEY" \
            access-key="$SCW_ACCESS_KEY" \
            organization-id="$SCW_DEFAULT_ORGANIZATION_ID" \
            project-id="$SCW_DEFAULT_PROJECT_ID" \
            region="$SCW_DEFAULT_REGION" \
            send-telemetry=false \
            with-ssh-key=false

      - name: Install kubeconfig for cluster
        env:
          SCW_DEFAULT_REGION: ${{ secrets.SCW_DEFAULT_REGION }}
        run: |
          CLUSTER_ID=$(cat k8s_cluster_id)
          scw k8s kubeconfig install "$CLUSTER_ID" --export > kubeconfig
          mkdir -p ~/.kube
          mv kubeconfig ~/.kube/config

      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl

      - name: Docker login to Scaleway registry
        env:
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
        run: |
          echo "$SCW_SECRET_KEY" | docker login rg.pl-waw.scw.cloud/garganache -u nologin --password-stdin

      - name: Build backend image
        run: |
          docker build -t $BACKEND_IMAGE:${{ github.sha }} backend

      - name: Build frontend image
        run: |
          docker build -t $FRONTEND_IMAGE:${{ github.sha }} frontend

      - name: Push backend image
        run: |
          docker push $BACKEND_IMAGE:${{ github.sha }}

      - name: Push frontend image
        run: |
          docker push $FRONTEND_IMAGE:${{ github.sha }}

      - name: Deploy to Kubernetes
        run: |
          # Ensure namespace exists before other manifests
          kubectl apply -f k8s/namespace.yaml

          # Apply core app manifests
          kubectl apply -f k8s/backend.yaml -f k8s/frontend.yaml -f k8s/ingress.yaml

          # Update images to the commit-specific tags
          kubectl -n mobi-dev set image deployment/mobi-backend mobi-backend=$BACKEND_IMAGE:${{ github.sha }}
          kubectl -n mobi-dev set image deployment/mobi-frontend mobi-frontend=$FRONTEND_IMAGE:${{ github.sha }}

          # Show deployed resources
          kubectl -n mobi-dev get pods
          echo "--- mobi-dev services ---"
          kubectl -n mobi-dev get svc
          echo "--- mobi-dev ingress ---"
          kubectl -n mobi-dev get ingress -o wide
